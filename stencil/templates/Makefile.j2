# Makefile for course activities
DC = docker compose

{% if has_services %}
# Services that run persistently
SERVICES = {{ services | join(' ') }}{% if has_web and 'nginx' not in services %} nginx{% endif %}

{% endif %}
{% if package_type == "zip" %}
PKG = {{ package_name }}

{% endif %}
{% set phony = ['help'] %}
{% if deps_script %}{% do phony.extend(['deps']) %}{% endif %}
{% if has_services %}{% do phony.extend(['up', 'down', 'ps', 'prune']) %}{% endif %}
{% do phony.append('format-md') %}
{% if package_type == "zip" %}{% do phony.append('pkg') %}{% endif %}
{% if has_pdfs %}{% do phony.append('pdf') %}{% endif %}
{% do phony.append('clean') %}
{% if has_mysql %}{% do phony.extend(['mysql', 'mysql-reset', 'mysql-version', 'lint-sql', 'fix-sql', 'run']) %}{% endif %}
{% if sql_import %}{% do phony.append(sql_import.target) %}{% endif %}
{% if has_web %}{% do phony.extend(['lint', 'fix']) %}{% endif %}
.PHONY: {{ phony | join(' ') }}

# Default target
ifeq ($(OS),Windows_NT)
help: ## Show this help message
	@echo Available targets:
	@powershell -NoProfile -Command "Get-Content $(MAKEFILE_LIST) | Select-String '^[a-zA-Z_-]+:.*?## .*$$' | ForEach-Object { $$_ -match '^([a-zA-Z_-]+):.*?## (.*)$$' | Out-Null; '  {0,-15} {1}' -f $$matches[1], $$matches[2] } | Select-Object -Unique"
else
help: ## Show this help message
	@echo "Available targets:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  %-15s %s\n", $$1, $$2}' | uniq
endif

{% if deps_script %}
ifeq ($(OS),Windows_NT)
deps: ## Install dependencies (requires make to be installed first)
{% for script in deps_script.Windows_NT %}
	@powershell -NoProfile -ExecutionPolicy Bypass -File scripts/{{ script }}
{% endfor %}
else
deps: ## Install dependencies (requires make to be installed first)
{% for script in deps_script.default %}
	@./scripts/{{ script }}
{% endfor %}
endif

{% endif %}
{% if has_services %}
ifeq ($(OS),Windows_NT)
up: ## Start the development environment
	$(DC) pull $(SERVICES)
	$(DC) up -d --build $(SERVICES)
	@powershell -NoProfile -Command "Write-Host ''; Write-Host 'Services are running:'"
{% if has_web %}
	@powershell -NoProfile -Command "Write-Host ('  nginx:  http://localhost:' + ((docker compose port nginx 80) -split ':')[-1])"
{% endif %}
{% if has_mysql %}
	@powershell -NoProfile -Command "Write-Host ('  mysql:  localhost:' + ((docker compose port mysql 3306) -split ':')[-1])"
{% endif %}
{% if has_web %}
	@powershell -NoProfile -Command "Write-Host '  php-fpm: (internal, accessed via nginx)'"
{% endif %}
else
up: ## Start the development environment
	$(DC) pull $(SERVICES)
	$(DC) up -d --build $(SERVICES)
	@echo ""
	@echo "Services are running:"
{% if has_web %}
	@printf "  nginx:  http://localhost:%s\n" "$$(docker compose port nginx 80 | cut -d: -f2)"
{% endif %}
{% if has_mysql %}
	@printf "  mysql:  localhost:%s\n" "$$(docker compose port mysql 3306 | cut -d: -f2)"
{% endif %}
{% if has_web %}
	@echo "  php-fpm: (internal, accessed via nginx)"
{% endif %}
endif

down: ## Stop the development environment
	$(DC) down $(SERVICES)

ps: ## Show status of running containers
	$(DC) ps

ifeq ($(OS),Windows_NT)
prune: down ## Remove all unused Docker resources (containers, images, volumes, networks)
	@echo WARNING: This will remove ALL unused Docker containers, images, volumes, and networks!
	@echo This action cannot be undone.
	@powershell -NoProfile -Command "$$confirm = Read-Host 'Are you sure you want to continue? Type yes to confirm'; if ($$confirm -match '^(y|yes)$$') { Write-Host 'Pruning Docker system...'; docker system prune -af --volumes } else { Write-Host 'Operation cancelled.' }"
else
prune: down ## Remove all unused Docker resources (containers, images, volumes, networks)
	@echo "WARNING: This will remove ALL unused Docker containers, images, volumes, and networks!"
	@echo "This action cannot be undone."
	@printf "Are you sure you want to continue? Type 'yes' to confirm: "; \
	read confirm; \
	if [ "$$confirm" = "yes" ] || [ "$$confirm" = "YES" ] || [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		echo "Pruning Docker system..."; \
		docker system prune -af --volumes; \
	else \
		echo "Operation cancelled."; \
	fi
endif

{% endif %}
{% include 'Makefile-pdf.j2' %}
{% if has_mysql %}
# Note: Credentials should match MYSQL_USER and MYSQL_PASSWORD in docker-compose.yml
mysql: ## Open MySQL shell (usage: `make mysql` or `make mysql ARGS="-e 'SHOW DATABASES'"`)
	$(DC) exec mysql mysql -u root -prootsecret $(ARGS)

mysql-reset: ## Reset MySQL database (removes all data)
	$(DC) down -v mysql
	$(DC) up -d mysql
	@echo "MySQL database reset. Waiting for it to be ready..."
	@sleep 5
	@echo "MySQL is ready."

mysql-version: ## Check MySQL version (requires environment to be running)
	$(DC) exec mysql mysql -u app -psecret -e "SELECT VERSION();"

{% endif %}
{% if has_mysql %}
fix-sql: ## Fix SQL files
	$(DC) pull fix-sql
	$(DC) run --rm fix-sql

lint-sql: fix-sql ## Lint SQL files
	$(DC) pull lint-sql
	$(DC) run --rm lint-sql

run: ## Run a SQL file (usage: make run P=1)
ifndef P
	@echo "Usage: make run P=<problem_number>"
	@echo "Example: make run P=1"
else
	$(DC) exec -T mysql mysql -u root -prootsecret < db/p$(P).sql
endif

{% endif %}
{% if sql_import %}
{{ sql_import.target }}: ## Import the {{ sql_import.database }} database
	$(DC) exec mysql mysql -u root -prootsecret -e "CREATE DATABASE IF NOT EXISTS {{ sql_import.database }};"
	$(DC) exec -T mysql mysql -u root -prootsecret {{ sql_import.database }} < {{ sql_import.file }}
	@echo "{{ sql_import.database | capitalize }} database imported successfully."

{% endif %}
{% if has_web %}
fix: ## Auto-fix HTML and PHP files
	$(DC) pull fix-html fix-php
	$(DC) run --rm fix-html
	$(DC) run --rm fix-php

lint: fix ## Auto-fix then lint HTML and PHP files
	$(DC) pull lint-html lint-php
	$(DC) run --rm lint-html
	$(DC) run --rm lint-php

{% endif %}
{% if package_type == "zip" %}
{% set pkg_deps = [] %}
{% if has_web %}{% do pkg_deps.append('lint') %}{% endif %}
{% if has_mysql %}{% do pkg_deps.append('lint-sql') %}{% endif %}
ifeq ($(OS),Windows_NT)
pkg: {{ pkg_deps | join(' ') }} ## Create submission zip file
	@echo Creating submission zip file...
	powershell.exe -Command "Compress-Archive -Path {{ package_folder }} -DestinationPath \"$(PKG)\" -Force"
	@echo Created $(PKG)
	@echo Upload $(PKG) to the course website.
else
pkg: {{ pkg_deps | join(' ') }} ## Create submission zip file
	@echo "Creating submission zip file..."
	zip -r $(PKG) {{ package_folder }}
	@echo "Created $(PKG)"
	@echo "Upload $(PKG) to the course website."
endif

{% endif %}
clean: ## Remove generated files
	rm -f {% if package_type == "zip" %}$(PKG) {% endif %}{% for md in pdfs %}{{ md | replace('.md', '.pdf') }} {% endfor %}
